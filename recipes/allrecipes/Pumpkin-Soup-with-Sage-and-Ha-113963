In a large pot, melt the butter over moderate heat. Add the onion, carrot, celery, and apple and cook, stirring occasionally, until the onion is translucent, about 10 minutes. Stir in the pumpkin puree, wine, sage, and bay leaf. Add the water, broth, salt, and pepper and bring to a simmer. Reduce the heat and simmer, partially covered, for 15 minutes. Add the ham and simmer, uncovered, until the vegetables are tender, about 5 minutes longer. Remove the bay leaf.